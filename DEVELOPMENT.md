# ZAT å¼€å‘æŒ‡å—

## å½“å‰è¿›åº¦

âœ… **å·²å®Œæˆ**
- [x] é¡¹ç›®åŸºç¡€æ¶æ„æ­å»º
- [x] Tauri + Svelte å‰ç«¯æ¡†æ¶
- [x] Python FastAPI åç«¯æ¡†æ¶
- [x] ADB æ§åˆ¶å™¨ï¼ˆè¿æ¥ã€æˆªå›¾ã€ç‚¹å‡»ã€æ»‘åŠ¨ï¼‰
- [x] WebSocket æ—¥å¿—æµ
- [x] WebSocket çŠ¶æ€æµ
- [x] HTTP æˆªå›¾ç«¯ç‚¹ï¼ˆDebug æ¨¡å¼ï¼‰
- [x] å‰ç«¯ UI ç»„ä»¶ï¼ˆTaskControl, LogViewer, StatusBar, DebugPanelï¼‰

ğŸš§ **å¾…å¼€å‘**
- [ ] å›¾åƒè¯†åˆ«å¼•æ“ï¼ˆæ¨¡æ¿åŒ¹é…ï¼‰
- [ ] ä»»åŠ¡é…ç½®ç³»ç»Ÿï¼ˆJSON åŠ è½½ï¼‰
- [ ] çŠ¶æ€æœºå®ç°
- [ ] å®Œæ•´ä»»åŠ¡æµç¨‹
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•
- [ ] é…ç½®æ–‡ä»¶ç®¡ç†

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£… Python ä¾èµ–

```bash
cd backend
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# æˆ– Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 2. å¯åŠ¨åç«¯ï¼ˆç»ˆç«¯ 1ï¼‰

```bash
cd backend
source venv/bin/activate
python main.py
```

åç«¯å°†åœ¨ `http://127.0.0.1:8000` å¯åŠ¨

### 3. å¯åŠ¨å‰ç«¯ï¼ˆç»ˆç«¯ 2ï¼‰

```bash
pnpm tauri dev
```

### 4. è¿æ¥æ¨¡æ‹Ÿå™¨

```bash
# å¯åŠ¨ MuMu æ¨¡æ‹Ÿå™¨

# è¿æ¥ ADB
adb connect 127.0.0.1:16384

# éªŒè¯
adb devices
```

## æµ‹è¯• API

### ä½¿ç”¨ curl æµ‹è¯•

```bash
# å¥åº·æ£€æŸ¥
curl http://127.0.0.1:8000/

# è¿æ¥è®¾å¤‡
curl -X POST http://127.0.0.1:8000/connect

# è·å–çŠ¶æ€
curl http://127.0.0.1:8000/status

# å¯åŠ¨ä»»åŠ¡
curl -X POST "http://127.0.0.1:8000/start?task_name=farming"

# åœæ­¢ä»»åŠ¡
curl -X POST http://127.0.0.1:8000/stop

# è·å–æˆªå›¾
curl http://127.0.0.1:8000/debug/screenshot -o screenshot.jpg
```

### ä½¿ç”¨æµè§ˆå™¨æµ‹è¯•

æ‰“å¼€ `http://127.0.0.1:8000/docs` æŸ¥çœ‹ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£

## é¡¹ç›®æ¶æ„

### é€šä¿¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Svelte å‰ç«¯                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ TaskControl  â”‚  â”‚  LogViewer   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  StatusBar   â”‚  â”‚ DebugPanel   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â”‚ HTTP               â”‚ WebSocket
         â†“                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Python Backend (FastAPI)                â”‚
â”‚                                                       â”‚
â”‚  HTTP ç«¯ç‚¹:                                          â”‚
â”‚  â”œâ”€ POST /connect                                    â”‚
â”‚  â”œâ”€ GET  /status                                     â”‚
â”‚  â”œâ”€ POST /start                                      â”‚
â”‚  â”œâ”€ POST /stop                                       â”‚
â”‚  â””â”€ GET  /debug/screenshot                           â”‚
â”‚                                                       â”‚
â”‚  WebSocket ç«¯ç‚¹:                                     â”‚
â”‚  â”œâ”€ /ws/log    (æ—¥å¿—æµ)                             â”‚
â”‚  â””â”€ /ws/state  (çŠ¶æ€æµ)                             â”‚
â”‚                                                       â”‚
â”‚  æ ¸å¿ƒæ¨¡å—:                                           â”‚
â”‚  â”œâ”€ ADBController   (ADB æ§åˆ¶)                      â”‚
â”‚  â”œâ”€ TaskEngine      (ä»»åŠ¡å¼•æ“)                      â”‚
â”‚  â””â”€ LogBroadcaster  (æ—¥å¿—å¹¿æ’­)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ADB
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MuMu æ¨¡æ‹Ÿå™¨ (127.0.0.1:16384)          â”‚
â”‚                   æ–å‰‘ä¼ è¯´                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æˆªå›¾ä¼ è¾“æ–¹æ¡ˆ

**HTTP æ‹‰å–å¼ï¼ˆå·²å®ç°ï¼‰**

```
å‰ç«¯ç‚¹å‡»"åˆ·æ–°æˆªå›¾"
    â†“
GET /debug/screenshot?gray=false
    â†“
Python: adb exec-out screencap -p
    â†“
OpenCV: JPEG ç¼–ç ï¼ˆè´¨é‡ 65ï¼‰
    â†“
è¿”å› JPEG bytes
    â†“
å‰ç«¯æ˜¾ç¤ºå›¾ç‰‡
```

**ä¼˜åŠ¿ï¼š**
- âœ… æŒ‰éœ€è·å–ï¼Œé›¶æ€§èƒ½å‹åŠ›
- âœ… ä¸ä½¿ç”¨ Base64ï¼Œç›´æ¥ä¼ è¾“äºŒè¿›åˆ¶
- âœ… å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨è®¿é—®æµ‹è¯•

## ä¸‹ä¸€æ­¥å¼€å‘

### Phase 1: å›¾åƒè¯†åˆ«å¼•æ“

åˆ›å»º `python-backend/core/vision.py`ï¼š

```python
class VisionEngine:
    def load_template(self, name: str, path: str)
    def match_template(self, screenshot, template_name, threshold=0.8)
    def find_all(self, screenshot, template_name, threshold=0.8)
```

### Phase 2: ä»»åŠ¡é…ç½®ç³»ç»Ÿ

åˆ›å»º `resources/tasks/farming.json`ï¼š

```json
{
  "name": "farming",
  "tasks": [
    {
      "task_name": "StartBattle",
      "recognition": {
        "method": "template_match",
        "template": "start_button.png",
        "threshold": 0.8
      },
      "action": {
        "type": "click",
        "target": "self"
      },
      "next": ["WaitBattleEnd"]
    }
  ]
}
```

### Phase 3: çŠ¶æ€æœº

æ›´æ–° `python-backend/core/task_engine.py`ï¼š

```python
class StateMachine:
    IDLE -> START_GAME -> ENTER_STAGE -> IN_BATTLE -> RESULT -> IDLE
```

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Python æ—¥å¿—

åç«¯ä¼šåœ¨ç»ˆç«¯è¾“å‡ºè¯¦ç»†æ—¥å¿—

### 2. æŸ¥çœ‹å‰ç«¯æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹ Console

### 3. æµ‹è¯• ADB è¿æ¥

```bash
# æŸ¥çœ‹è®¾å¤‡
adb devices

# æ‰‹åŠ¨æˆªå›¾æµ‹è¯•
adb -s 127.0.0.1:16384 exec-out screencap -p > test.png

# æ‰‹åŠ¨ç‚¹å‡»æµ‹è¯•
adb -s 127.0.0.1:16384 shell input tap 640 360
```

### 4. æµ‹è¯• WebSocket

ä½¿ç”¨æµè§ˆå™¨ Consoleï¼š

```javascript
// æµ‹è¯•æ—¥å¿—æµ
const ws = new WebSocket('ws://127.0.0.1:8000/ws/log');
ws.onmessage = (e) => console.log(JSON.parse(e.data));

// æµ‹è¯•çŠ¶æ€æµ
const ws2 = new WebSocket('ws://127.0.0.1:8000/ws/state');
ws2.onmessage = (e) => console.log(JSON.parse(e.data));
```

## å¸¸è§é—®é¢˜

### Q: ADB è¿æ¥å¤±è´¥ï¼Ÿ

```bash
# 1. ç¡®è®¤æ¨¡æ‹Ÿå™¨å·²å¯åŠ¨
# 2. ç¡®è®¤ ADB å·²å®‰è£…
adb version

# 3. é‡å¯ ADB æœåŠ¡
adb kill-server
adb start-server

# 4. æ‰‹åŠ¨è¿æ¥
adb connect 127.0.0.1:16384
```

### Q: Python ä¾èµ–å®‰è£…å¤±è´¥ï¼Ÿ

```bash
# å‡çº§ pip
pip install --upgrade pip

# å•ç‹¬å®‰è£… OpenCV
pip install opencv-python-headless

# å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å›½å†…é•œåƒ
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### Q: å‰ç«¯æ— æ³•è¿æ¥åç«¯ï¼Ÿ

1. ç¡®è®¤åç«¯å·²å¯åŠ¨ï¼ˆ`http://127.0.0.1:8000`ï¼‰
2. æ£€æŸ¥ CORS é…ç½®
3. æŸ¥çœ‹æµè§ˆå™¨ Console é”™è¯¯ä¿¡æ¯

## ä»£ç è§„èŒƒ

### Python

- ä½¿ç”¨ Type Hints
- ä½¿ç”¨ async/await
- æ—¥å¿—ä½¿ç”¨ loggerï¼Œä¸è¦ç”¨ print
- å¼‚å¸¸è¦æœ‰è¯¦ç»†ä¿¡æ¯

### TypeScript

- ä½¿ç”¨ä¸¥æ ¼ç±»å‹
- ç»„ä»¶è¦æœ‰æ¸…æ™°çš„ props å®šä¹‰
- ä½¿ç”¨ async/await å¤„ç†å¼‚æ­¥

## Git æäº¤è§„èŒƒ

```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤ bug
docs: æ–‡æ¡£æ›´æ–°
refactor: é‡æ„
test: æµ‹è¯•
chore: æ„å»º/å·¥å…·
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æˆªå›¾ä¼˜åŒ–**
   - ä½¿ç”¨ `exec-out` è€Œä¸æ˜¯ `pull`
   - JPEG è´¨é‡ 60-70 è¶³å¤Ÿ
   - Debug æ¨¡å¼æ‰ä¼ è¾“æˆªå›¾

2. **è¯†åˆ«ä¼˜åŒ–**
   - ä½¿ç”¨ ROI å‡å°‘æœç´¢èŒƒå›´
   - ç¼“å­˜æ¨¡æ¿å›¾ç‰‡
   - è€ƒè™‘ä½¿ç”¨ç°åº¦å›¾

3. **ä»»åŠ¡ä¼˜åŒ–**
   - åˆç†è®¾ç½®å»¶è¿Ÿ
   - é¿å…è¿‡åº¦é‡è¯•
   - åŠæ—¶é‡Šæ”¾èµ„æº

## èµ„æº

- [Tauri æ–‡æ¡£](https://tauri.app/)
- [Svelte æ–‡æ¡£](https://svelte.dev/)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [OpenCV æ–‡æ¡£](https://docs.opencv.org/)
- [ADB æ–‡æ¡£](https://developer.android.com/tools/adb)
