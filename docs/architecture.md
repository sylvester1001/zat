# 架构设计

## 整体架构

```
┌────────────────────────────────────────────────────────────┐
│                      ZAT Desktop App                       │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌──────────────────┐      HTTP/WS      ┌───────────────┐ │
│  │   Svelte UI      │◄────────────────►│  Python       │ │
│  │   (TypeScript)   │                   │  Backend      │ │
│  └────────┬─────────┘                   │  (FastAPI)    │ │
│           │                             └───────┬───────┘ │
│           │ IPC                                 │ ADB     │
│           ▼                                     ▼         │
│  ┌──────────────────┐                   ┌───────────────┐ │
│  │   Tauri Shell    │                   │   Android     │ │
│  │   (Rust)         │                   │   Emulator    │ │
│  └──────────────────┘                   └───────────────┘ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

## 核心模块

### ADB Controller
设备连接与控制层，封装 ADB 命令：
- 设备发现与连接
- 截图获取
- 触摸事件模拟
- 应用启停

### Image Matcher
图像识别引擎：
- 模板匹配（OpenCV）
- OCR 文字识别
- 多尺度匹配

### Scene Graph
场景图系统，定义游戏内场景及转换关系：
```
主界面 ──► 副本入口 ──► 副本选择 ──► 战斗
   ▲                                  │
   └──────────────────────────────────┘
```

### Game Navigator
基于场景图的智能导航：
- 当前场景检测
- 最短路径计算
- 自动执行转换

### Dungeon Runner
副本执行器：
- 单次/循环/无限模式
- 战斗状态机
- 结果统计

### Task Engine
任务引擎（自动化调度）：
- 任务队列管理
- 状态机驱动
- 异常恢复

## 通信机制

### HTTP
- 同步请求/响应
- 设备连接、副本执行等操作

### WebSocket
- 实时双向通信
- 日志流推送
- 状态变更通知

## 状态流转

### 副本状态机

```
IDLE ──► NAVIGATING ──► ENTERING ──► FIGHTING ──► COLLECTING ──► EXITING
  ▲                                                                  │
  └──────────────────────────────────────────────────────────────────┘
```

| 状态 | 说明 |
|------|------|
| IDLE | 空闲 |
| NAVIGATING | 导航到副本入口 |
| ENTERING | 进入副本 |
| FIGHTING | 战斗中 |
| COLLECTING | 收集奖励 |
| EXITING | 退出副本 |

## 设计原则

1. **分层解耦** - UI / Shell / Backend 职责分离
2. **状态驱动** - 基于状态机的流程控制
3. **实时反馈** - WebSocket 推送关键状态
4. **容错设计** - 异常检测与自动恢复
